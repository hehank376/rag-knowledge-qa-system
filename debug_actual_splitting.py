#!/usr/bin/env python3
"""
è°ƒè¯•å®é™…çš„åˆ†å‰²è¿‡ç¨‹
"""
import asyncio
from rag_system.api.document_api import get_document_service

async def test_actual_splitting():
    """æµ‹è¯•å®é™…çš„åˆ†å‰²è¿‡ç¨‹"""
    print("ğŸ” æµ‹è¯•å®é™…çš„åˆ†å‰²è¿‡ç¨‹...")
    
    try:
        # è·å–æ–‡æ¡£æœåŠ¡
        service = await get_document_service()
        processor = service.document_processor
        
        # åˆ›å»ºæµ‹è¯•æ–‡æœ¬ï¼ˆç±»ä¼¼äºå®é™…çš„å¤§æ–‡æ¡£ï¼‰
        test_text = """
# æ·±åº¦å­¦ä¹ ä¸äººå·¥æ™ºèƒ½æŠ€æœ¯å…¨é¢è§£æ

## å¼•è¨€
äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼ŒAIï¼‰ä½œä¸º21ä¸–çºªæœ€å…·é©å‘½æ€§çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œæ­£åœ¨æ·±åˆ»æ”¹å˜ç€æˆ‘ä»¬çš„ç”Ÿæ´»æ–¹å¼ã€å·¥ä½œæ¨¡å¼å’Œç¤¾ä¼šç»“æ„ã€‚ä»æ—©æœŸçš„ç¬¦å·ä¸»ä¹‰AIåˆ°ç°ä»£çš„æ·±åº¦å­¦ä¹ ï¼Œäººå·¥æ™ºèƒ½æŠ€æœ¯ç»å†äº†å¤šæ¬¡é‡å¤§çªç ´å’Œå‘å±•ã€‚

## ç¬¬ä¸€ç« ï¼šäººå·¥æ™ºèƒ½å‘å±•å†ç¨‹

### 1.1 æ—©æœŸå‘å±•é˜¶æ®µï¼ˆ1950-1980å¹´ä»£ï¼‰
äººå·¥æ™ºèƒ½çš„æ¦‚å¿µæœ€æ—©å¯ä»¥è¿½æº¯åˆ°1950å¹´ï¼Œå½“æ—¶è‹±å›½æ•°å­¦å®¶é˜¿å…°Â·å›¾çµæå‡ºäº†è‘—åçš„"å›¾çµæµ‹è¯•"ï¼Œä¸ºåˆ¤æ–­æœºå™¨æ˜¯å¦å…·æœ‰æ™ºèƒ½æä¾›äº†ä¸€ä¸ªæ ‡å‡†ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œç ”ç©¶è€…ä»¬ä¸»è¦å…³æ³¨ç¬¦å·æ¨ç†ã€ä¸“å®¶ç³»ç»Ÿå’ŒçŸ¥è¯†è¡¨ç¤ºç­‰é¢†åŸŸã€‚

ä¸“å®¶ç³»ç»Ÿæ˜¯è¿™ä¸€æ—¶æœŸçš„é‡è¦æˆæœï¼Œå®ƒé€šè¿‡å°†äººç±»ä¸“å®¶çš„çŸ¥è¯†ç¼–ç åˆ°è®¡ç®—æœºç¨‹åºä¸­ï¼Œä½¿è®¡ç®—æœºèƒ½å¤Ÿåœ¨ç‰¹å®šé¢†åŸŸå†…è¿›è¡Œæ¨ç†å’Œå†³ç­–ã€‚ç„¶è€Œï¼Œç”±äºçŸ¥è¯†è·å–çš„å›°éš¾æ€§å’Œæ¨ç†èƒ½åŠ›çš„å±€é™æ€§ï¼Œä¸“å®¶ç³»ç»Ÿçš„åº”ç”¨èŒƒå›´ç›¸å¯¹æœ‰é™ã€‚

### 1.2 æœºå™¨å­¦ä¹ å…´èµ·ï¼ˆ1980-2000å¹´ä»£ï¼‰
éšç€è®¡ç®—èƒ½åŠ›çš„æå‡å’Œæ•°æ®é‡çš„å¢åŠ ï¼Œæœºå™¨å­¦ä¹ é€æ¸æˆä¸ºäººå·¥æ™ºèƒ½ç ”ç©¶çš„ä¸»æµæ–¹å‘ã€‚è¿™ä¸€æ—¶æœŸå‡ºç°äº†è®¸å¤šé‡è¦çš„æœºå™¨å­¦ä¹ ç®—æ³•ï¼ŒåŒ…æ‹¬å†³ç­–æ ‘ã€æ”¯æŒå‘é‡æœºã€ç¥ç»ç½‘ç»œç­‰ã€‚

ç¥ç»ç½‘ç»œè™½ç„¶åœ¨1980å¹´ä»£å°±å·²ç»å‡ºç°ï¼Œä½†ç”±äºè®¡ç®—èµ„æºçš„é™åˆ¶å’Œè®­ç»ƒç®—æ³•çš„ä¸æˆç†Ÿï¼Œå…¶å‘å±•ä¸€åº¦é™·å…¥ä½è°·ã€‚ç›´åˆ°åå‘ä¼ æ’­ç®—æ³•çš„æå‡ºå’Œå®Œå–„ï¼Œç¥ç»ç½‘ç»œæ‰é‡æ–°è·å¾—å…³æ³¨ã€‚

## ç¬¬äºŒç« ï¼šæ·±åº¦å­¦ä¹ æ ¸å¿ƒæŠ€æœ¯

### 2.1 ç¥ç»ç½‘ç»œåŸºç¡€
ç¥ç»ç½‘ç»œæ˜¯æ·±åº¦å­¦ä¹ çš„åŸºç¡€ï¼Œå®ƒæ¨¡æ‹Ÿäº†äººè„‘ç¥ç»å…ƒçš„å·¥ä½œåŸç†ã€‚ä¸€ä¸ªåŸºæœ¬çš„ç¥ç»ç½‘ç»œç”±è¾“å…¥å±‚ã€éšè—å±‚å’Œè¾“å‡ºå±‚ç»„æˆï¼Œæ¯ä¸€å±‚åŒ…å«å¤šä¸ªç¥ç»å…ƒï¼ˆèŠ‚ç‚¹ï¼‰ï¼Œç¥ç»å…ƒä¹‹é—´é€šè¿‡æƒé‡è¿æ¥ã€‚

ç¥ç»ç½‘ç»œçš„å­¦ä¹ è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­ä¸¤ä¸ªé˜¶æ®µã€‚åœ¨å‰å‘ä¼ æ’­ä¸­ï¼Œè¾“å…¥æ•°æ®é€šè¿‡ç½‘ç»œå±‚å±‚ä¼ é€’ï¼Œæœ€ç»ˆäº§ç”Ÿè¾“å‡ºç»“æœã€‚åœ¨åå‘ä¼ æ’­ä¸­ï¼Œç½‘ç»œæ ¹æ®è¾“å‡ºç»“æœä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„è¯¯å·®ï¼Œè°ƒæ•´å„å±‚çš„æƒé‡å‚æ•°ã€‚

### 2.2 å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰
å·ç§¯ç¥ç»ç½‘ç»œæ˜¯ä¸“é—¨ç”¨äºå¤„ç†å…·æœ‰ç½‘æ ¼ç»“æ„æ•°æ®ï¼ˆå¦‚å›¾åƒï¼‰çš„æ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚CNNé€šè¿‡å·ç§¯æ“ä½œã€æ± åŒ–æ“ä½œå’Œå…¨è¿æ¥å±‚çš„ç»„åˆï¼Œèƒ½å¤Ÿæœ‰æ•ˆæå–å›¾åƒçš„å±€éƒ¨ç‰¹å¾å’Œå…¨å±€ç‰¹å¾ã€‚

å·ç§¯å±‚æ˜¯CNNçš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒä½¿ç”¨å¯å­¦ä¹ çš„æ»¤æ³¢å™¨ï¼ˆå·ç§¯æ ¸ï¼‰åœ¨è¾“å…¥æ•°æ®ä¸Šè¿›è¡Œå·ç§¯æ“ä½œï¼Œæå–ä¸åŒçš„ç‰¹å¾ã€‚æ± åŒ–å±‚åˆ™ç”¨äºé™ä½ç‰¹å¾å›¾çš„ç©ºé—´ç»´åº¦ï¼Œå‡å°‘è®¡ç®—é‡å¹¶æé«˜æ¨¡å‹çš„é²æ£’æ€§ã€‚
""" * 3  # é‡å¤3æ¬¡ä»¥åˆ›å»ºæ›´å¤§çš„æ–‡æ¡£
        
        print(f"ğŸ“„ æµ‹è¯•æ–‡æœ¬é•¿åº¦: {len(test_text)} å­—ç¬¦")
        
        # æµ‹è¯•æ–‡æœ¬åˆ†å‰²
        print("\nâœ‚ï¸ æµ‹è¯•æ–‡æœ¬åˆ†å‰²...")
        import uuid
        test_doc_id = str(uuid.uuid4())
        
        chunks = processor.split_text(test_text, test_doc_id)
        
        print(f"âœ… åˆ†å‰²æˆåŠŸ: ç”Ÿæˆ {len(chunks)} ä¸ªæ–‡æœ¬å—")
        
        for i, chunk in enumerate(chunks[:5]):  # åªæ˜¾ç¤ºå‰5ä¸ªå—
            print(f"ğŸ“ å— {i+1}: é•¿åº¦={len(chunk.content)}")
            print(f"   å†…å®¹é¢„è§ˆ: {chunk.content[:100]}...")
            print(f"   å…ƒæ•°æ®: {chunk.metadata.get('split_method', 'unknown')}")
            print()
        
        if len(chunks) > 5:
            print(f"... è¿˜æœ‰ {len(chunks) - 5} ä¸ªå—")
        
        # æ¸…ç†
        await service.cleanup()
        
    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(test_actual_splitting())