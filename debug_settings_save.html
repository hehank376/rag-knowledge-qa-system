<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾ç½®ä¿å­˜è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .debug-output { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
        button { padding: 10px 15px; margin: 5px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        input, select { padding: 5px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ è®¾ç½®ä¿å­˜è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>1. æµ‹è¯•é…ç½®éªŒè¯</h2>
        <button onclick="testConfigValidation()">æµ‹è¯•é…ç½®éªŒè¯</button>
        <div id="validationResult" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <h2>2. æµ‹è¯•é…ç½®ä¿å­˜</h2>
        <div>
            <label>LLMæä¾›å•†: </label>
            <select id="llmProvider">
                <option value="siliconflow">SiliconFlow</option>
                <option value="openai">OpenAI</option>
                <option value="deepseek">DeepSeek</option>
            </select>
        </div>
        <div>
            <label>LLMæ¨¡å‹: </label>
            <input type="text" id="llmModel" value="Qwen/Qwen2-7B-Instruct">
        </div>
        <div>
            <label>æ¸©åº¦: </label>
            <input type="number" id="llmTemperature" value="0.7" step="0.1" min="0" max="2">
        </div>
        <div>
            <label>æœ€å¤§ä»¤ç‰Œ: </label>
            <input type="number" id="llmMaxTokens" value="2000" min="100" max="4000">
        </div>
        <button onclick="testConfigSave()">æµ‹è¯•é…ç½®ä¿å­˜</button>
        <div id="saveResult" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <h2>3. æµ‹è¯•å•ä¸ªé…ç½®èŠ‚ä¿å­˜</h2>
        <button onclick="testSingleSectionSave()">æµ‹è¯•LLMé…ç½®ä¿å­˜</button>
        <div id="singleSaveResult" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <h2>4. æŸ¥çœ‹ç½‘ç»œè¯·æ±‚è¯¦æƒ…</h2>
        <button onclick="enableNetworkLogging()">å¯ç”¨ç½‘ç»œæ—¥å¿—</button>
        <div id="networkLog" class="debug-output"></div>
    </div>

    <script>
        // ç®€åŒ–çš„APIå®¢æˆ·ç«¯
        class DebugAPIClient {
            constructor(baseURL = 'http://localhost:8000') {
                this.baseURL = baseURL;
                this.networkLog = [];
            }

            async request(url, options = {}) {
                const config = {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                };

                const requestInfo = {
                    url: `${this.baseURL}${url}`,
                    method: config.method || 'GET',
                    headers: config.headers,
                    body: config.body,
                    timestamp: new Date().toISOString()
                };

                this.networkLog.push({ type: 'request', ...requestInfo });
                this.updateNetworkLog();

                try {
                    const response = await fetch(`${this.baseURL}${url}`, config);
                    
                    const responseInfo = {
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries()),
                        timestamp: new Date().toISOString()
                    };

                    this.networkLog.push({ type: 'response', ...responseInfo });

                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch {
                            errorData = { detail: response.statusText };
                        }
                        
                        this.networkLog.push({ 
                            type: 'error', 
                            error: errorData,
                            timestamp: new Date().toISOString()
                        });
                        
                        throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const contentType = response.headers.get('content-type');
                    let responseData;
                    if (contentType && contentType.includes('application/json')) {
                        responseData = await response.json();
                    } else {
                        responseData = await response.text();
                    }

                    this.networkLog.push({ 
                        type: 'data', 
                        data: responseData,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.updateNetworkLog();
                    return responseData;

                } catch (error) {
                    this.networkLog.push({ 
                        type: 'exception', 
                        error: error.message,
                        timestamp: new Date().toISOString()
                    });
                    this.updateNetworkLog();
                    throw error;
                }
            }

            updateNetworkLog() {
                const logDiv = document.getElementById('networkLog');
                if (logDiv) {
                    logDiv.textContent = JSON.stringify(this.networkLog, null, 2);
                }
            }

            async get(url) {
                return this.request(url, { method: 'GET' });
            }

            async post(url, data) {
                return this.request(url, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            async put(url, data) {
                return this.request(url, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            }
        }

        const debugAPI = new DebugAPIClient();

        // æµ‹è¯•é…ç½®éªŒè¯
        async function testConfigValidation() {
            const resultDiv = document.getElementById('validationResult');
            resultDiv.textContent = 'æµ‹è¯•é…ç½®éªŒè¯ä¸­...';
            
            const testConfig = {
                provider: document.getElementById('llmProvider').value,
                model: document.getElementById('llmModel').value,
                temperature: parseFloat(document.getElementById('llmTemperature').value),
                max_tokens: parseInt(document.getElementById('llmMaxTokens').value)
            };
            
            try {
                const result = await debugAPI.post('/config/validate', {
                    section: 'llm',
                    config: testConfig
                });
                
                resultDiv.textContent = `âœ… éªŒè¯æˆåŠŸ:\n${JSON.stringify(result, null, 2)}`;
                resultDiv.className = 'debug-output success';
                
            } catch (error) {
                resultDiv.textContent = `âŒ éªŒè¯å¤±è´¥:\n${error.message}`;
                resultDiv.className = 'debug-output error';
            }
        }

        // æµ‹è¯•é…ç½®ä¿å­˜
        async function testConfigSave() {
            const resultDiv = document.getElementById('saveResult');
            resultDiv.textContent = 'æµ‹è¯•é…ç½®ä¿å­˜ä¸­...';
            
            const settings = {
                app: {
                    name: "RAG Knowledge QA System (Dev)",
                    debug: true
                },
                llm: {
                    provider: document.getElementById('llmProvider').value,
                    model: document.getElementById('llmModel').value,
                    temperature: parseFloat(document.getElementById('llmTemperature').value),
                    max_tokens: parseInt(document.getElementById('llmMaxTokens').value)
                },
                embeddings: {
                    provider: "siliconflow",
                    model: "BAAI/bge-large-zh-v1.5",
                    chunk_size: 400,
                    chunk_overlap: 50
                }
            };
            
            try {
                // å…ˆéªŒè¯
                const validationResult = await debugAPI.post('/config/validate', {
                    section: 'all',
                    config: settings
                });
                
                if (!validationResult.valid) {
                    throw new Error(`é…ç½®éªŒè¯å¤±è´¥: ${JSON.stringify(validationResult.errors)}`);
                }
                
                // å†ä¿å­˜
                const saveResult = await debugAPI.put('/config/all', settings);
                
                resultDiv.textContent = `âœ… ä¿å­˜æˆåŠŸ:\n${JSON.stringify(saveResult, null, 2)}`;
                resultDiv.className = 'debug-output success';
                
            } catch (error) {
                resultDiv.textContent = `âŒ ä¿å­˜å¤±è´¥:\n${error.message}`;
                resultDiv.className = 'debug-output error';
            }
        }

        // æµ‹è¯•å•ä¸ªé…ç½®èŠ‚ä¿å­˜
        async function testSingleSectionSave() {
            const resultDiv = document.getElementById('singleSaveResult');
            resultDiv.textContent = 'æµ‹è¯•å•ä¸ªé…ç½®èŠ‚ä¿å­˜ä¸­...';
            
            const llmConfig = {
                provider: document.getElementById('llmProvider').value,
                model: document.getElementById('llmModel').value,
                temperature: parseFloat(document.getElementById('llmTemperature').value),
                max_tokens: parseInt(document.getElementById('llmMaxTokens').value)
            };
            
            try {
                const result = await debugAPI.put('/config/llm', llmConfig);
                
                resultDiv.textContent = `âœ… å•ä¸ªé…ç½®èŠ‚ä¿å­˜æˆåŠŸ:\n${JSON.stringify(result, null, 2)}`;
                resultDiv.className = 'debug-output success';
                
            } catch (error) {
                resultDiv.textContent = `âŒ å•ä¸ªé…ç½®èŠ‚ä¿å­˜å¤±è´¥:\n${error.message}`;
                resultDiv.className = 'debug-output error';
            }
        }

        // å¯ç”¨ç½‘ç»œæ—¥å¿—
        function enableNetworkLogging() {
            debugAPI.networkLog = [];
            debugAPI.updateNetworkLog();
            document.getElementById('networkLog').textContent = 'ç½‘ç»œæ—¥å¿—å·²å¯ç”¨ï¼Œæ‰§è¡Œå…¶ä»–æ“ä½œæŸ¥çœ‹è¯¦ç»†è¯·æ±‚ä¿¡æ¯...';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸ”§ è®¾ç½®ä¿å­˜è°ƒè¯•å·¥å…·å·²åŠ è½½');
            enableNetworkLogging();
        };
    </script>
</body>
</html>