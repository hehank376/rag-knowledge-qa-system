# ä»»åŠ¡3.1å®Œæˆæ€»ç»“ï¼šå®ç°é‡æ’åºæœåŠ¡ç»„ä»¶

## ä»»åŠ¡æ¦‚è¿°
ä»»åŠ¡3.1è¦æ±‚å®ç°é‡æ’åºæœåŠ¡ç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼š
- åˆ›å»º RerankingService ç±»ï¼Œé›†æˆ sentence-transformers
- å®ç°é‡æ’åºæ¨¡å‹çš„åŠ è½½å’Œåˆå§‹åŒ–
- å®ç°æŸ¥è¯¢-æ–‡æ¡£å¯¹çš„é‡æ’åºè®¡ç®—
- æ·»åŠ é‡æ’åºç»“æœçš„åˆ†æ•°æ›´æ–°å’Œæ’åº

## å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºé‡æ’åºæœåŠ¡æ ¸å¿ƒç»„ä»¶

#### RerankingService ç±»
åˆ›å»ºäº†å®Œæ•´çš„é‡æ’åºæœåŠ¡ç±» `rag_system/services/reranking_service.py`ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

**æ¨¡å‹ç®¡ç†åŠŸèƒ½ï¼š**
- å¼‚æ­¥æ¨¡å‹åŠ è½½å’Œåˆå§‹åŒ–
- æ”¯æŒå¤šç§äº¤å‰ç¼–ç å™¨æ¨¡å‹ï¼ˆé»˜è®¤ä½¿ç”¨ ms-marco-MiniLM-L-6-v2ï¼‰
- æ¨¡å‹é¢„åŠ è½½å’Œé¢„çƒ­åŠŸèƒ½
- æ¨¡å‹èµ„æºç®¡ç†å’Œæ¸…ç†

**é‡æ’åºè®¡ç®—åŠŸèƒ½ï¼š**
- æŸ¥è¯¢-æ–‡æ¡£å¯¹çš„é‡æ’åºè®¡ç®—
- æ‰¹å¤„ç†ä¼˜åŒ–ï¼ˆæ”¯æŒé…ç½®æ‰¹å¤„ç†å¤§å°ï¼‰
- å¼‚æ­¥å¤„ç†å’Œè¶…æ—¶æ§åˆ¶
- ç»“æœåˆ†æ•°æ›´æ–°å’Œé‡æ–°æ’åº

**æ€§èƒ½ç›‘æ§åŠŸèƒ½ï¼š**
- è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡æ”¶é›†ï¼ˆRerankingMetricsï¼‰
- è¯·æ±‚æˆåŠŸç‡å’Œå¤±è´¥ç‡ç»Ÿè®¡
- å¹³å‡å¤„ç†æ—¶é—´å’Œæ¨¡å‹åŠ è½½æ—¶é—´è®°å½•
- å¥åº·æ£€æŸ¥å’ŒçŠ¶æ€ç›‘æ§

**é”™è¯¯å¤„ç†å’Œé™çº§ï¼š**
- æ¨¡å‹åŠ è½½å¤±è´¥æ—¶çš„ä¼˜é›…é™çº§
- é‡æ’åºè®¡ç®—å¼‚å¸¸æ—¶è¿”å›åŸå§‹ç»“æœ
- è¶…æ—¶æ§åˆ¶å’Œèµ„æºç®¡ç†
- å®Œæ•´çš„é”™è¯¯æ—¥å¿—è®°å½•

### 2. é«˜çº§åŠŸèƒ½ç»„ä»¶

#### RerankingServiceManager ç±»
å®ç°äº†é‡æ’åºæœåŠ¡ç®¡ç†å™¨ï¼Œæ”¯æŒï¼š
- å¤šæ¨¡å‹ç®¡ç†å’Œåˆ‡æ¢
- æœåŠ¡çš„ç»Ÿä¸€åˆå§‹åŒ–å’Œç®¡ç†
- æ‰€æœ‰æœåŠ¡çš„å¥åº·æ£€æŸ¥
- ç»Ÿä¸€çš„æŒ‡æ ‡æ”¶é›†å’Œç›‘æ§

#### æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½
- **é™åˆ¶é‡æ’åº**ï¼š`rerank_with_limit` æ–¹æ³•åªå¯¹å‰Nä¸ªç»“æœé‡æ’åº
- **æ‰¹å¤„ç†ä¼˜åŒ–**ï¼šæ”¯æŒå¤§æ‰¹é‡æ–‡æ¡£çš„åˆ†æ‰¹å¤„ç†
- **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨çº¿ç¨‹æ± é¿å…é˜»å¡ä¸»çº¿ç¨‹
- **è¶…æ—¶æ§åˆ¶**ï¼šé˜²æ­¢é•¿æ—¶é—´è®¡ç®—é˜»å¡ç³»ç»Ÿ

#### è£…é¥°å™¨æ”¯æŒ
æä¾›äº† `@rerank_results` è£…é¥°å™¨ï¼Œæ–¹ä¾¿é›†æˆåˆ°ç°æœ‰çš„æ£€ç´¢æ–¹æ³•ä¸­ã€‚

### 3. æµ‹è¯•è¦†ç›–

åˆ›å»ºäº†å…¨é¢çš„æµ‹è¯•å¥—ä»¶ `tests/services/test_reranking_service.py`ï¼ŒåŒ…å«40ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

#### RerankingMetrics æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰
- æŒ‡æ ‡åˆå§‹åŒ–æµ‹è¯•
- æˆåŠŸè¯·æ±‚æŒ‡æ ‡æ›´æ–°æµ‹è¯•
- å¤±è´¥è¯·æ±‚æŒ‡æ ‡æ›´æ–°æµ‹è¯•

#### RerankingService æµ‹è¯•ï¼ˆ26ä¸ªæµ‹è¯•ï¼‰
- æœåŠ¡åˆå§‹åŒ–å’Œé…ç½®æµ‹è¯•
- æ¨¡å‹åŠ è½½æˆåŠŸ/å¤±è´¥åœºæ™¯æµ‹è¯•
- é‡æ’åºåŠŸèƒ½çš„å„ç§åœºæ™¯æµ‹è¯•
- æ€§èƒ½æŒ‡æ ‡æ”¶é›†å’Œé‡ç½®æµ‹è¯•
- å¥åº·æ£€æŸ¥å’Œæ¢å¤æœºåˆ¶æµ‹è¯•
- èµ„æºç®¡ç†å’Œæ¸…ç†æµ‹è¯•

#### RerankingServiceManager æµ‹è¯•ï¼ˆ9ä¸ªæµ‹è¯•ï¼‰
- ç®¡ç†å™¨åˆå§‹åŒ–å’ŒæœåŠ¡ç®¡ç†æµ‹è¯•
- å¤šæœåŠ¡å¥åº·æ£€æŸ¥æµ‹è¯•
- æœåŠ¡è·å–å’Œé‡æ’åºè°ƒç”¨æµ‹è¯•

#### è£…é¥°å™¨æµ‹è¯•ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰
- é‡æ’åºè£…é¥°å™¨çš„å¯ç”¨/ç¦ç”¨æµ‹è¯•

### 4. æ ¸å¿ƒç‰¹æ€§

#### æ™ºèƒ½é™çº§æœºåˆ¶
```python
# é‡æ’åºåŠŸèƒ½ç¦ç”¨æ—¶
if not config.enable_rerank:
    return results

# æ¨¡å‹æœªåŠ è½½æ—¶
if not self.model_loaded:
    return results

# é‡æ’åºå¤±è´¥æ—¶
except Exception as e:
    logger.error(f"é‡æ’åºå¤±è´¥: {e}ï¼Œè¿”å›åŸå§‹ç»“æœ")
    return results
```

#### æ€§èƒ½ç›‘æ§
```python
@dataclass
class RerankingMetrics:
    total_requests: int = 0
    successful_requests: int = 0
    failed_requests: int = 0
    average_processing_time: float = 0.0
    model_load_time: float = 0.0
    
    @property
    def success_rate(self) -> float:
        return self.successful_requests / self.total_requests if self.total_requests > 0 else 0.0
```

#### æ‰¹å¤„ç†ä¼˜åŒ–
```python
def _compute_rerank_scores(self, pairs: List[Tuple[str, str]]) -> List[float]:
    if len(pairs) <= self.batch_size:
        scores = self.reranker_model.predict(pairs)
    else:
        # å¤šæ‰¹å¤„ç†
        scores = []
        for i in range(0, len(pairs), self.batch_size):
            batch = pairs[i:i + self.batch_size]
            batch_scores = self.reranker_model.predict(batch)
            scores.extend(batch_scores)
```

#### å¼‚æ­¥å¤„ç†å’Œè¶…æ—¶æ§åˆ¶
```python
try:
    scores = await asyncio.wait_for(
        loop.run_in_executor(None, self._compute_rerank_scores, pairs),
        timeout=self.timeout
    )
except asyncio.TimeoutError:
    raise Exception("é‡æ’åºè®¡ç®—è¶…æ—¶")
```

### 5. é…ç½®æ”¯æŒ

æ”¯æŒä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼š
```python
config = {
    'model_name': 'cross-encoder/ms-marco-MiniLM-L-6-v2',  # æ¨¡å‹åç§°
    'max_length': 512,                                      # æœ€å¤§æ–‡æœ¬é•¿åº¦
    'batch_size': 32,                                       # æ‰¹å¤„ç†å¤§å°
    'timeout': 30.0,                                        # è¶…æ—¶æ—¶é—´
    'rerank_top_k': 50,                                     # é‡æ’åºç»“æœæ•°é‡é™åˆ¶
    'enable_model_cache': True,                             # å¯ç”¨æ¨¡å‹ç¼“å­˜
    'model_cache_size': 1                                   # ç¼“å­˜æ¨¡å‹æ•°é‡
}
```

### 6. é›†æˆæ¥å£

æä¾›äº†ç®€æ´çš„é›†æˆæ¥å£ï¼š
```python
# åŸºæœ¬ä½¿ç”¨
reranking_service = RerankingService(config)
await reranking_service.initialize()
reranked_results = await reranking_service.rerank_results(query, results, config)

# è£…é¥°å™¨ä½¿ç”¨
@rerank_results(reranking_service)
async def search_method(self, query, config, **kwargs):
    return await self.original_search(query, config, **kwargs)

# ç®¡ç†å™¨ä½¿ç”¨
manager = RerankingServiceManager(manager_config)
await manager.initialize()
results = await manager.rerank_with_service(query, results, config, 'primary')
```

## éœ€æ±‚æ»¡è¶³æƒ…å†µ

### éœ€æ±‚2.1ï¼ˆé‡æ’åºåŸºç¡€åŠŸèƒ½ï¼‰âœ…
- å®ç°äº†å®Œæ•´çš„é‡æ’åºæœåŠ¡ç±»
- é›†æˆäº† sentence-transformers äº¤å‰ç¼–ç å™¨
- æ”¯æŒæŸ¥è¯¢-æ–‡æ¡£å¯¹çš„ç›¸å…³æ€§è¯„åˆ†

### éœ€æ±‚2.2ï¼ˆé‡æ’åºè®¡ç®—ï¼‰âœ…
- å®ç°äº†é«˜æ•ˆçš„é‡æ’åºè®¡ç®—é€»è¾‘
- æ”¯æŒæ‰¹å¤„ç†ä¼˜åŒ–æé«˜æ€§èƒ½
- ç»“æœæŒ‰é‡æ’åºåˆ†æ•°æ­£ç¡®æ’åº

### éœ€æ±‚2.3ï¼ˆæ¨¡å‹ç®¡ç†ï¼‰âœ…
- å®ç°äº†æ¨¡å‹çš„å¼‚æ­¥åŠ è½½å’Œåˆå§‹åŒ–
- æ”¯æŒæ¨¡å‹é¢„åŠ è½½å’Œé¢„çƒ­
- æä¾›äº†æ¨¡å‹èµ„æºç®¡ç†å’Œæ¸…ç†

### éœ€æ±‚2.4ï¼ˆç»“æœå¤„ç†ï¼‰âœ…
- æ­£ç¡®æ›´æ–°æ£€ç´¢ç»“æœçš„ç›¸ä¼¼åº¦åˆ†æ•°
- ä¿ç•™åŸå§‹åˆ†æ•°ä¿¡æ¯åœ¨å…ƒæ•°æ®ä¸­
- æŒ‰é‡æ’åºåˆ†æ•°é‡æ–°æ’åºç»“æœ

## æŠ€æœ¯äº®ç‚¹

### 1. å¼‚æ­¥å¤„ç†æ¶æ„
- ä½¿ç”¨å¼‚æ­¥åˆå§‹åŒ–é¿å…é˜»å¡
- çº¿ç¨‹æ± æ‰§è¡Œé‡æ’åºè®¡ç®—
- è¶…æ—¶æ§åˆ¶é˜²æ­¢é•¿æ—¶é—´é˜»å¡

### 2. æ™ºèƒ½é™çº§æœºåˆ¶
- æ¨¡å‹åŠ è½½å¤±è´¥æ—¶ä¼˜é›…é™çº§
- é‡æ’åºè®¡ç®—å¼‚å¸¸æ—¶è¿”å›åŸå§‹ç»“æœ
- é…ç½®ç¦ç”¨æ—¶ç›´æ¥è·³è¿‡å¤„ç†

### 3. æ€§èƒ½ä¼˜åŒ–
- æ‰¹å¤„ç†å‡å°‘æ¨¡å‹è°ƒç”¨æ¬¡æ•°
- é™åˆ¶é‡æ’åºåªå¤„ç†å‰Nä¸ªç»“æœ
- æ–‡æœ¬é•¿åº¦æˆªæ–­é¿å…å†…å­˜é—®é¢˜

### 4. å…¨é¢ç›‘æ§
- è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨æ¢å¤
- å®Œæ•´çš„é”™è¯¯æ—¥å¿—è®°å½•

### 5. çµæ´»é…ç½®
- æ”¯æŒå¤šç§äº¤å‰ç¼–ç å™¨æ¨¡å‹
- å¯é…ç½®çš„æ‰¹å¤„ç†å’Œè¶…æ—¶å‚æ•°
- å¤šæœåŠ¡ç®¡ç†å’Œåˆ‡æ¢æ”¯æŒ

## æµ‹è¯•ç»“æœ

æ‰€æœ‰40ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼š
```
======================= 40 passed, 11 warnings in 1.79s =======================
```

æµ‹è¯•è¦†ç›–äº†ï¼š
- âœ… æœåŠ¡åˆå§‹åŒ–å’Œé…ç½®
- âœ… æ¨¡å‹åŠ è½½çš„å„ç§åœºæ™¯
- âœ… é‡æ’åºåŠŸèƒ½çš„æ­£ç¡®æ€§
- âœ… é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶
- âœ… æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†
- âœ… èµ„æºç®¡ç†å’Œæ¸…ç†
- âœ… å¤šæœåŠ¡ç®¡ç†åŠŸèƒ½
- âœ… è£…é¥°å™¨é›†æˆåŠŸèƒ½

## æ€»ç»“

ä»»åŠ¡3.1å·²æˆåŠŸå®Œæˆï¼Œå®ç°äº†åŠŸèƒ½å®Œæ•´ã€æ€§èƒ½ä¼˜åŒ–ã€é”™è¯¯å¤„ç†å®Œå–„çš„é‡æ’åºæœåŠ¡ç»„ä»¶ã€‚è¯¥ç»„ä»¶ï¼š

1. **åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒåŸºäºäº¤å‰ç¼–ç å™¨çš„é‡æ’åºè®¡ç®—
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹å¤„ç†ã€å¼‚æ­¥å¤„ç†ã€è¶…æ—¶æ§åˆ¶
3. **é”™è¯¯å¤„ç†**ï¼šæ™ºèƒ½é™çº§ã€å¼‚å¸¸æ¢å¤ã€å®Œæ•´æ—¥å¿—
4. **æ˜“äºé›†æˆ**ï¼šè£…é¥°å™¨æ”¯æŒã€ç®€æ´æ¥å£ã€çµæ´»é…ç½®
5. **ç›‘æ§å®Œå–„**ï¼šæ€§èƒ½æŒ‡æ ‡ã€å¥åº·æ£€æŸ¥ã€çŠ¶æ€ç›‘æ§

é‡æ’åºæœåŠ¡ç»„ä»¶å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥é›†æˆåˆ°æ£€ç´¢æµç¨‹ä¸­ä½¿ç”¨ï¼ğŸš€

ä¸‹ä¸€æ­¥å¯ä»¥ç»§ç»­æ‰§è¡Œä»»åŠ¡3.2ï¼šé›†æˆé‡æ’åºåˆ°æ£€ç´¢æµç¨‹ã€‚