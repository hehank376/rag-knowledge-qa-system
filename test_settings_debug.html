<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾ç½®é¡µé¢è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .debug-output { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        button { padding: 10px 15px; margin: 5px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ğŸ” è®¾ç½®é¡µé¢è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>1. APIè¿æ¥æµ‹è¯•</h2>
        <button onclick="testConfigAPI()">æµ‹è¯•é…ç½®API</button>
        <button onclick="testMonitoringAPI()">æµ‹è¯•ç›‘æ§API</button>
        <div id="apiTestResult" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <h2>2. é…ç½®æ•°æ®ç»“æ„</h2>
        <button onclick="loadAndShowConfig()">åŠ è½½å¹¶æ˜¾ç¤ºé…ç½®</button>
        <div id="configStructure" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <h2>3. è®¾ç½®è¡¨å•æµ‹è¯•</h2>
        <button onclick="testFormPopulation()">æµ‹è¯•è¡¨å•å¡«å……</button>
        <div id="formTestResult" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <h2>4. ç›‘æ§æ•°æ®å±•ç¤º</h2>
        <button onclick="loadMonitoringData()">åŠ è½½ç›‘æ§æ•°æ®</button>
        <div id="monitoringData" class="debug-output"></div>
    </div>

    <script>
        // ç®€åŒ–çš„APIå®¢æˆ·ç«¯
        class SimpleAPIClient {
            constructor(baseURL = 'http://localhost:8000') {
                this.baseURL = baseURL;
            }

            async request(url, options = {}) {
                const config = {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                };

                try {
                    const response = await fetch(`${this.baseURL}${url}`, config);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('APIè¯·æ±‚å¤±è´¥:', error);
                    throw error;
                }
            }

            async get(url) {
                return this.request(url, { method: 'GET' });
            }

            async post(url, data) {
                return this.request(url, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }
        }

        const api = new SimpleAPIClient();

        // æµ‹è¯•é…ç½®API
        async function testConfigAPI() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.innerHTML = '<p class="info">æµ‹è¯•ä¸­...</p>';
            
            const tests = [
                { name: 'è·å–å®Œæ•´é…ç½®', url: '/config/' },
                { name: 'è·å–LLMé…ç½®', url: '/config/llm' },
                { name: 'è·å–åµŒå…¥é…ç½®', url: '/config/embeddings' },
                { name: 'è·å–æ£€ç´¢é…ç½®', url: '/config/retrieval' },
                { name: 'å¥åº·æ£€æŸ¥', url: '/config/health' }
            ];
            
            let results = [];
            
            for (const test of tests) {
                try {
                    const result = await api.get(test.url);
                    results.push(`<p class="success">âœ… ${test.name}: æˆåŠŸ</p>`);
                    console.log(`${test.name}:`, result);
                } catch (error) {
                    results.push(`<p class="error">âŒ ${test.name}: ${error.message}</p>`);
                }
            }
            
            resultDiv.innerHTML = results.join('');
        }

        // æµ‹è¯•ç›‘æ§API
        async function testMonitoringAPI() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.innerHTML += '<hr><p class="info">æµ‹è¯•ç›‘æ§API...</p>';
            
            const monitoringTests = [
                { name: 'ç³»ç»ŸçŠ¶æ€', url: '/monitoring/status' },
                { name: 'æ€§èƒ½æŒ‡æ ‡', url: '/monitoring/metrics' },
                { name: 'å¥åº·æ£€æŸ¥', url: '/monitoring/health' }
            ];
            
            let results = [];
            
            for (const test of monitoringTests) {
                try {
                    const result = await api.get(test.url);
                    results.push(`<p class="success">âœ… ${test.name}: æˆåŠŸ</p>`);
                    console.log(`ç›‘æ§-${test.name}:`, result);
                } catch (error) {
                    results.push(`<p class="error">âŒ ${test.name}: ${error.message}</p>`);
                }
            }
            
            resultDiv.innerHTML += results.join('');
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºé…ç½®
        async function loadAndShowConfig() {
            const resultDiv = document.getElementById('configStructure');
            resultDiv.innerHTML = '<p class="info">åŠ è½½é…ç½®ä¸­...</p>';
            
            try {
                const config = await api.get('/config/');
                
                // æ˜¾ç¤ºé…ç½®ç»“æ„
                const configData = config.config || config;
                
                let html = '<h3>ğŸ“‹ é…ç½®æ•°æ®ç»“æ„:</h3>';
                html += '<pre>' + JSON.stringify(configData, null, 2) + '</pre>';
                
                // æ£€æŸ¥å…³é”®å­—æ®µ
                html += '<h3>ğŸ” å…³é”®å­—æ®µæ£€æŸ¥:</h3>';
                html += `<p>åº”ç”¨åç§°: ${configData.app?.name || 'âŒ æœªæ‰¾åˆ°'}</p>`;
                html += `<p>LLMæä¾›å•†: ${configData.llm?.provider || 'âŒ æœªæ‰¾åˆ°'}</p>`;
                html += `<p>LLMæ¨¡å‹: ${configData.llm?.model || 'âŒ æœªæ‰¾åˆ°'}</p>`;
                html += `<p>LLMæ¸©åº¦: ${configData.llm?.temperature || 'âŒ æœªæ‰¾åˆ°'}</p>`;
                html += `<p>åµŒå…¥æä¾›å•†: ${configData.embeddings?.provider || 'âŒ æœªæ‰¾åˆ°'}</p>`;
                html += `<p>åµŒå…¥æ¨¡å‹: ${configData.embeddings?.model || 'âŒ æœªæ‰¾åˆ°'}</p>`;
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ åŠ è½½é…ç½®å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æµ‹è¯•è¡¨å•å¡«å……
        async function testFormPopulation() {
            const resultDiv = document.getElementById('formTestResult');
            resultDiv.innerHTML = '<p class="info">æµ‹è¯•è¡¨å•å¡«å……...</p>';
            
            try {
                const config = await api.get('/config/');
                const configData = config.config || config;
                
                // æ¨¡æ‹Ÿè¡¨å•å­—æ®µ
                const formFields = {
                    'systemName': configData.app?.name,
                    'llmProvider': configData.llm?.provider,
                    'llmModel': configData.llm?.model,
                    'llmTemperature': configData.llm?.temperature,
                    'llmMaxTokens': configData.llm?.max_tokens,
                    'embeddingProvider': configData.embeddings?.provider,
                    'embeddingModel': configData.embeddings?.model,
                    'chunkSize': configData.embeddings?.chunk_size,
                    'topK': configData.retrieval?.top_k,
                    'similarityThreshold': configData.retrieval?.similarity_threshold
                };
                
                let html = '<h3>ğŸ“ è¡¨å•å­—æ®µæ˜ å°„æµ‹è¯•:</h3>';
                for (const [field, value] of Object.entries(formFields)) {
                    const status = value !== undefined && value !== null ? 'âœ…' : 'âŒ';
                    html += `<p>${status} ${field}: ${value || 'æœªæ‰¾åˆ°'}</p>`;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ è¡¨å•å¡«å……æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }

        // åŠ è½½ç›‘æ§æ•°æ®
        async function loadMonitoringData() {
            const resultDiv = document.getElementById('monitoringData');
            resultDiv.innerHTML = '<p class="info">åŠ è½½ç›‘æ§æ•°æ®...</p>';
            
            try {
                // å°è¯•ä¸åŒçš„ç›‘æ§ç«¯ç‚¹
                const endpoints = [
                    '/monitoring/status',
                    '/monitoring/health', 
                    '/monitoring/metrics',
                    '/config/health'  // é…ç½®APIçš„å¥åº·æ£€æŸ¥
                ];
                
                let html = '<h3>ğŸ“Š ç›‘æ§æ•°æ®:</h3>';
                
                for (const endpoint of endpoints) {
                    try {
                        const data = await api.get(endpoint);
                        html += `<h4>âœ… ${endpoint}:</h4>`;
                        html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    } catch (error) {
                        html += `<h4>âŒ ${endpoint}: ${error.message}</h4>`;
                    }
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥: ${error.message}</p>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            console.log('ğŸš€ è®¾ç½®é¡µé¢è°ƒè¯•å·¥å…·å·²åŠ è½½');
            // è‡ªåŠ¨åŠ è½½é…ç½®
            loadAndShowConfig();
        };
    </script>
</body>
</html>