<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡æ’åºæ¨¡å‹é…ç½®ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .success {
            color: #28a745;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #0c5460;
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .config-display {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-results {
            margin-top: 20px;
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .test-pass {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .test-fail {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="section-title">ğŸ¯ é‡æ’åºæ¨¡å‹é…ç½®ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•é‡æ’åºæ¨¡å‹é…ç½®çš„è·å–ã€ä¿®æ”¹å’Œä¿å­˜åŠŸèƒ½</p>
    </div>

    <div class="container">
        <h2 class="section-title">ğŸ“‹ å½“å‰é‡æ’åºé…ç½®</h2>
        <button onclick="loadCurrentConfig()">ğŸ”„ åŠ è½½å½“å‰é…ç½®</button>
        <div id="currentConfig" class="config-display">ç‚¹å‡»"åŠ è½½å½“å‰é…ç½®"æŒ‰é’®æŸ¥çœ‹...</div>
    </div>

    <div class="container">
        <h2 class="section-title">â• æ·»åŠ é‡æ’åºæ¨¡å‹</h2>
        <form id="rerankingForm">
            <div class="form-group">
                <label for="modelName">æ¨¡å‹åç§°:</label>
                <input type="text" id="modelName" value="test-reranking-frontend" required>
            </div>
            
            <div class="form-group">
                <label for="provider">æä¾›å•†:</label>
                <select id="provider" required>
                    <option value="siliconflow">SiliconFlow</option>
                    <option value="openai">OpenAI</option>
                    <option value="sentence_transformers">Sentence Transformers</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="modelNameField">å…·ä½“æ¨¡å‹åç§°:</label>
                <input type="text" id="modelNameField" value="BAAI/bge-reranker-v2-m3" required>
            </div>
            
            <div class="form-group">
                <label for="batchSize">æ‰¹å¤„ç†å¤§å°:</label>
                <input type="number" id="batchSize" value="64" min="1" max="1000" required>
            </div>
            
            <div class="form-group">
                <label for="maxLength">æœ€å¤§æ–‡æœ¬é•¿åº¦:</label>
                <input type="number" id="maxLength" value="1024" min="1" max="10000" required>
            </div>
            
            <div class="form-group">
                <label for="timeout">è¶…æ—¶æ—¶é—´ (ç§’):</label>
                <input type="number" id="timeout" value="90" min="1" max="600" required>
            </div>
            
            <div class="form-group">
                <label for="apiKey">APIå¯†é’¥:</label>
                <input type="text" id="apiKey" value="sk-test-frontend-key" required>
            </div>
            
            <div class="form-group">
                <label for="baseUrl">åŸºç¡€URL:</label>
                <input type="text" id="baseUrl" value="https://api.siliconflow.cn/v1" required>
            </div>
            
            <button type="submit">ğŸ’¾ æ·»åŠ é‡æ’åºæ¨¡å‹</button>
            <button type="button" onclick="resetForm()">ğŸ”„ é‡ç½®è¡¨å•</button>
        </form>
        
        <div id="addResult"></div>
    </div>

    <div class="container">
        <h2 class="section-title">ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹</h2>
        <button onclick="runCompleteTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="testResults" class="test-results"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';

        // APIå®¢æˆ·ç«¯
        class APIClient {
            async request(method, url, data = null) {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(url, options);
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.detail || result.message || `HTTP ${response.status}`);
                    }
                    
                    return result;
                } catch (error) {
                    console.error('APIè¯·æ±‚å¤±è´¥:', error);
                    throw error;
                }
            }

            async get(url) {
                return this.request('GET', url);
            }

            async post(url, data) {
                return this.request('POST', url, data);
            }
        }

        const apiClient = new APIClient();

        // åŠ è½½å½“å‰é…ç½®
        async function loadCurrentConfig() {
            try {
                showMessage('æ­£åœ¨åŠ è½½é…ç½®...', 'info', 'currentConfig');
                
                const config = await apiClient.get(`${API_BASE_URL}/config/`);
                const rerankingConfig = config.config.reranking;
                
                if (rerankingConfig) {
                    const configText = `é‡æ’åºæ¨¡å‹é…ç½®:
æä¾›å•†: ${rerankingConfig.provider}
æ¨¡å‹: ${rerankingConfig.model}
æ¨¡å‹åç§°: ${rerankingConfig.model_name || rerankingConfig.model}
æ‰¹å¤„ç†å¤§å°: ${rerankingConfig.batch_size}
æœ€å¤§æ–‡æœ¬é•¿åº¦: ${rerankingConfig.max_length}
è¶…æ—¶æ—¶é—´: ${rerankingConfig.timeout}ç§’
APIå¯†é’¥: ${rerankingConfig.api_key ? rerankingConfig.api_key.substring(0, 15) + '...' : '(æœªè®¾ç½®)'}
åŸºç¡€URL: ${rerankingConfig.base_url}`;
                    
                    document.getElementById('currentConfig').textContent = configText;
                    showMessage('âœ… é…ç½®åŠ è½½æˆåŠŸ', 'success');
                } else {
                    document.getElementById('currentConfig').textContent = 'âŒ æœªæ‰¾åˆ°é‡æ’åºé…ç½®';
                    showMessage('âŒ æœªæ‰¾åˆ°é‡æ’åºé…ç½®', 'error');
                }
            } catch (error) {
                document.getElementById('currentConfig').textContent = `âŒ åŠ è½½å¤±è´¥: ${error.message}`;
                showMessage(`âŒ åŠ è½½é…ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ·»åŠ é‡æ’åºæ¨¡å‹
        document.getElementById('rerankingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                model_type: 'reranking',
                name: document.getElementById('modelName').value,
                provider: document.getElementById('provider').value,
                model_name: document.getElementById('modelNameField').value,
                config: {
                    provider: document.getElementById('provider').value,
                    batch_size: parseInt(document.getElementById('batchSize').value),
                    max_length: parseInt(document.getElementById('maxLength').value),
                    timeout: parseInt(document.getElementById('timeout').value),
                    api_key: document.getElementById('apiKey').value,
                    base_url: document.getElementById('baseUrl').value
                }
            };
            
            try {
                showMessage('æ­£åœ¨æ·»åŠ é‡æ’åºæ¨¡å‹...', 'info', 'addResult');
                
                const result = await apiClient.post(`${API_BASE_URL}/models/add`, formData);
                
                showMessage(`âœ… ${result.message}`, 'success', 'addResult');
                
                // è‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®
                setTimeout(() => {
                    loadCurrentConfig();
                }, 1000);
                
            } catch (error) {
                showMessage(`âŒ æ·»åŠ æ¨¡å‹å¤±è´¥: ${error.message}`, 'error', 'addResult');
            }
        });

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('rerankingForm').reset();
            document.getElementById('modelName').value = 'test-reranking-frontend';
            document.getElementById('provider').value = 'siliconflow';
            document.getElementById('modelNameField').value = 'BAAI/bge-reranker-v2-m3';
            document.getElementById('batchSize').value = '64';
            document.getElementById('maxLength').value = '1024';
            document.getElementById('timeout').value = '90';
            document.getElementById('apiKey').value = 'sk-test-frontend-key';
            document.getElementById('baseUrl').value = 'https://api.siliconflow.cn/v1';
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runCompleteTest() {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = '<p>ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•...</p>';
            
            const tests = [
                { name: 'åŠ è½½å½“å‰é…ç½®', func: testLoadConfig },
                { name: 'æ·»åŠ é‡æ’åºæ¨¡å‹', func: testAddModel },
                { name: 'éªŒè¯é…ç½®æ›´æ–°', func: testConfigUpdate },
                { name: 'éªŒè¯å‚æ•°æŒä¹…åŒ–', func: testParameterPersistence }
            ];
            
            let passedTests = 0;
            
            for (const test of tests) {
                try {
                    const result = await test.func();
                    if (result.success) {
                        addTestResult(test.name, 'âœ… é€šè¿‡', result.message, 'test-pass');
                        passedTests++;
                    } else {
                        addTestResult(test.name, 'âŒ å¤±è´¥', result.message, 'test-fail');
                    }
                } catch (error) {
                    addTestResult(test.name, 'âŒ é”™è¯¯', error.message, 'test-fail');
                }
                
                // æµ‹è¯•é—´éš”
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // æ˜¾ç¤ºæ€»ç»“
            const summary = document.createElement('div');
            summary.className = passedTests === tests.length ? 'success' : 'error';
            summary.innerHTML = `<h3>æµ‹è¯•æ€»ç»“</h3><p>é€šè¿‡: ${passedTests}/${tests.length}</p>`;
            testResults.appendChild(summary);
        }

        // æµ‹è¯•å‡½æ•°
        async function testLoadConfig() {
            const config = await apiClient.get(`${API_BASE_URL}/config/`);
            if (config.config.reranking) {
                return { success: true, message: 'æˆåŠŸåŠ è½½é‡æ’åºé…ç½®' };
            } else {
                return { success: false, message: 'æœªæ‰¾åˆ°é‡æ’åºé…ç½®' };
            }
        }

        async function testAddModel() {
            const testData = {
                model_type: 'reranking',
                name: 'test-complete-flow',
                provider: 'siliconflow',
                model_name: 'BAAI/bge-reranker-v2-m3',
                config: {
                    provider: 'siliconflow',
                    batch_size: 128,
                    max_length: 2048,
                    timeout: 120,
                    api_key: 'sk-test-complete-flow',
                    base_url: 'https://api.siliconflow.cn/v1'
                }
            };
            
            const result = await apiClient.post(`${API_BASE_URL}/models/add`, testData);
            return { success: true, message: result.message };
        }

        async function testConfigUpdate() {
            // ç­‰å¾…é…ç½®æ›´æ–°
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const config = await apiClient.get(`${API_BASE_URL}/config/`);
            const rerankingConfig = config.config.reranking;
            
            if (rerankingConfig.batch_size === 128 && rerankingConfig.max_length === 2048) {
                return { success: true, message: 'é…ç½®å‚æ•°å·²æ­£ç¡®æ›´æ–°' };
            } else {
                return { success: false, message: `é…ç½®æœªæ›´æ–°: batch_size=${rerankingConfig.batch_size}, max_length=${rerankingConfig.max_length}` };
            }
        }

        async function testParameterPersistence() {
            // æ¨¡æ‹Ÿé¡µé¢é‡æ–°åŠ è½½åçš„é…ç½®è·å–
            const config = await apiClient.get(`${API_BASE_URL}/config/`);
            const rerankingConfig = config.config.reranking;
            
            const expectedValues = {
                batch_size: 128,
                max_length: 2048,
                timeout: 120
            };
            
            for (const [key, expectedValue] of Object.entries(expectedValues)) {
                if (rerankingConfig[key] !== expectedValue) {
                    return { success: false, message: `å‚æ•° ${key} æœªæŒä¹…åŒ–: æœŸæœ› ${expectedValue}, å®é™… ${rerankingConfig[key]}` };
                }
            }
            
            return { success: true, message: 'æ‰€æœ‰å‚æ•°å·²æ­£ç¡®æŒä¹…åŒ–' };
        }

        // è¾…åŠ©å‡½æ•°
        function showMessage(message, type, targetId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            
            if (targetId) {
                const target = document.getElementById(targetId);
                target.innerHTML = '';
                target.appendChild(messageDiv);
            } else {
                document.body.appendChild(messageDiv);
                setTimeout(() => messageDiv.remove(), 5000);
            }
        }

        function addTestResult(testName, status, message, className) {
            const testResults = document.getElementById('testResults');
            const testItem = document.createElement('div');
            testItem.className = `test-item ${className}`;
            testItem.innerHTML = `<strong>${testName}</strong>: ${status}<br><small>${message}</small>`;
            testResults.appendChild(testItem);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®
        window.addEventListener('load', function() {
            loadCurrentConfig();
        });
    </script>
</body>
</html>